<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Updated Title -->
  <title>Smart Plug Switcher – make your electric devices run on renewables with software</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Load fonts: Using Roboto for a modern look -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet">
  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    /* Global Body Style: Clean light background with modern typography */
    body {
      background-color: #f7f7f7;
      color: #333;
      font-family: 'Roboto', sans-serif;
      font-size: 16px;
    }
    h1, h2, h3, h5 {
      color: #222;
      font-weight: 500;
    }
    .container {
      margin-top: 120px; /* Leave room for fixed navbar */
    }
    /* Navbar: White with subtle shadow */
    .navbar-custom {
      background-color: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .navbar-custom .navbar-brand,
    .navbar-custom .nav-link {
      color: #333;
    }
    .navbar-custom .nav-link:hover {
      color: #007bff;
    }
    /* Jumbotron styled as a modern card */
    .jumbotron {
      padding: 2rem 1rem;
      margin-bottom: 2rem;
      border-radius: 8px;
      background-color: #ffffff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    /* Marketing Text */
    #marketing a {
      color: #007bff;
      text-decoration: underline;
    }
    /* YouTube Player Container with rounded corners and shadow */
    .video-container {
      position: relative;
      padding-bottom: 56.25%; /* 16:9 */
      padding-top: 30px;
      height: 0;
      overflow: hidden;
      margin-bottom: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .video-container iframe,
    .video-container object,
    .video-container embed {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 8px;
    }
    /* Forecast & Smart Plug Settings Sections */
    #forecastSection, #smartPlugSettingsSection {
      margin-bottom: 40px;
    }
    /* Plug Settings Panel */
    #plugSchedulePanel {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .plugEntry {
      border: 1px solid #e0e0e0;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      background-color: #fafafa;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .plugStatus {
      font-weight: bold;
      margin-top: 5px;
    }
    .form-text {
      font-size: 0.85rem;
      color: #666;
    }
    /* Graph Styling */
    #mergedGraph {
      border: 1px solid #e0e0e0;
      padding: 10px;
      background-color: #ffffff;
      border-radius: 8px;
      width: 100%;
      height: 400px;
    }
    /* Timer Styling in Navbar Collapse */
    #timerLabelCollapse {
      font-size: 1rem;
      color: #333;
    }
    /* Navbar Collapse Background */
    .navbar-collapse {
      background-color: #ffffff;
    }
    /* Overview Buttons and Cards */
    .overview-button {
      margin-bottom: 10px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
    }
    .overview-card {
      background-color: #ffffff;
      color: #333;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #e0e0e0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    /* Pricing Tier Table */
    #tierTable {
      margin-top: 40px;
    }
    #tierTable th, #tierTable td {
      text-align: center;
      vertical-align: middle;
    }
    #tierTable td:first-child {
      text-align: left;
      font-weight: 500;
    }
    .feature-note {
      font-size: 0.85rem;
      color: #666;
    }
    /* History Log Grouping Styles */
    .logDateHeader {
      background: #e9ecef;
      padding: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    /* Slider Thumb and Track Styling */
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      background: transparent;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background: var(--thumb-color, #007bff);
      margin-top: -8px;
      cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background: var(--thumb-color, #007bff);
      cursor: pointer;
    }
    input[type="range"]::-ms-thumb {
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background: var(--thumb-color, #007bff);
      cursor: pointer;
    }
    input[type="range"]::-webkit-slider-runnable-track {
      height: 4px;
      background: var(--thumb-color, #007bff);
    }
    input[type="range"]::-moz-range-track {
      height: 4px;
      background: var(--thumb-color, #007bff);
    }
    input[type="range"]::-ms-track {
      height: 4px;
      background: var(--thumb-color, #007bff);
    }
  </style>
</head>
<body>
  <!-- Fixed Navbar with Hamburger Menu -->
  <nav class="navbar navbar-light fixed-top navbar-custom">
    <a class="navbar-brand" href="#">Smart Plug Switcher</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMain">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse" id="navbarMain">
      <div class="p-3">
        <ul class="navbar-nav">
          <!-- Navigation links if needed -->
        </ul>
        <hr class="bg-secondary">
        <div class="mb-2">
          <strong id="timerLabelCollapse">Next Forecast:</strong> <span id="refreshTimer"></span>
        </div>
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-success btn-sm" id="saveSettingsBtn" title="Save your current configuration.">Save Settings</button>
          <button type="button" class="btn btn-warning btn-sm" id="loadSettingsBtn" title="Load your previously saved configuration.">Load Settings</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="container">
    <!-- Marketing Text Section -->
    <div class="jumbotron" id="marketing">
      <h1>Ever wondered if your appliances could save you money?</h1>
      <p>
        Imagine if your everyday devices automatically adjusted their schedules to run only when renewable energy is at its peak. With Smart Plug Switcher, you can effortlessly upgrade your existing electric devices — like your (Water) Heaters, Battery Chargers, Hot Tubs, Fans, Fridges, <a href="https://unboundsolar.com/solar-information/power-table?srsltid=AfmBOorWqW1Nq55yEx8AOuI2x0OWv-94g1V12WiayllWSbAY6vb7hG01" target="_blank">etc.</a> — to operate during peak solar or wind hours.
      </p>
      <p>
        This solution is perfect for devices that already turn on and off during the day but aren’t smart enough to take the weather forecast into account. Benefits include:
      </p>
      <ul>
        <li><strong>Reduced Energy Bills:</strong> Only run devices when energy is cheapest and greenest.</li>
        <li><strong>Lower Carbon Footprint:</strong> Optimize your energy usage to align with renewable energy availability.</li>
        <li><strong>Seamless Integration:</strong> Easily retrofit your existing devices with a standard smart plug.</li>
      </ul>
      <p>
        To get started, all you need is to <a href="https://smart-in-home.com/what-is-smart-plugs/" target="_blank">install a standard smart plug</a> and just scroll down this page to try it yourself.
      </p>
    </div>
    
    <!-- YouTube Player Section -->
    <div class="video-container">
      <iframe src="https://www.youtube.com/embed/Z-JGed2F-7I" 
              frameborder="0" 
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
              allowfullscreen>
      </iframe>
    </div>

    <!-- Location Display and Manual Input -->
    <div id="locationDisplay" class="mt-3">
      <p>Location will appear here when retrieved.</p>
    </div>
    <button id="getGeoBtn" class="btn btn-primary mb-3">Get Geolocation Automatically</button>
    <h2 class="mt-5">Enter Location Manually</h2>
    <form id="locationForm">
      <div class="form-group">
        <input type="text" class="form-control" id="manualLocation" placeholder="Enter village or city name" required>
        <small class="form-text">Type the name of your village or city to fetch coordinates and weather.</small>
      </div>
      <div id="timerContainer">
        <button type="submit" class="btn btn-secondary">Retrieve Weather</button>
      </div>
    </form>
    <div id="manualLocationResult" class="mt-3"></div>
    
    <!-- Forecast Section -->
    <div id="forecastSection" class="mt-5">
      <h3>Weather & Renewable Energy Forecast</h3>
      <div class="form-group">
        <label for="energySlider">
          My area has: <span id="sunWeightLabel">38</span>% Solar Panels / <span id="windWeightLabel">62</span>% Wind Turbines
        </label>
        <input type="range" class="form-control-range" id="energySlider" min="0" max="100" value="38">
        <small class="form-text">
          Adjust the slider to set the weighting between solar panel availability vs wind turbines.
          (Upcoming: A regional database will automatically adjust this based on your location.)
        </small>
      </div>
      <div id="mergedGraph"></div>
    </div>
    
    <!-- Smart Plug Settings Section -->
    <div id="smartPlugSettingsSection" class="mt-5">
      <h3 class="text-center">Smart Plug Settings</h3>
      <div class="row">
        <div class="col-md-6">
          <label>Select your preferred scheduling method:</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="scheduleType" id="userPlanned" value="user">
            <label class="form-check-label" for="userPlanned">User Planned</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="scheduleType" id="optimized" value="optimized" checked>
            <label class="form-check-label" for="optimized">Optimized (Weather-based)</label>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-body text-center">
              <h5 class="card-title">The Profit Forecast</h5>
              <div id="profitInfographicValue">
                <p>0.00 kWh</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="plugSchedulePanel">
        <div id="plugList"></div>
        <button type="button" class="btn btn-outline-secondary mb-2" id="addPlugBtn">Add Plug</button>
        <small class="form-text mb-2">
          Click "Add Plug" to add a new smart plug. Fill in the details below for each plug.
        </small>
        <button type="button" class="btn btn-info btn-block" id="updatePlugsBtn">Update Plug Schedules</button>
      </div>
    </div>
    
    <!-- Pricing Tiers Section -->
    <div id="tierSection" class="mt-5">
      <h3 class="text-center">Pricing Tiers</h3>
      <table id="tierTable" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Feature</th>
            <th>Free</th>
            <th>Standard</th>
            <th>Professional</th>
            <th>Enterprise</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Basic Scheduling<br><span class="feature-note">(24-hour horizon)</span></td>
            <td>X</td>
            <td>X</td>
            <td>X</td>
            <td>X</td>
          </tr>
          <tr>
            <td>Extended Scheduling<br><span class="feature-note">(Up to 72 hours)</span></td>
            <td></td>
            <td>X</td>
            <td>X</td>
            <td>X</td>
          </tr>
          <tr>
            <td>Long-term Scheduling<br><span class="feature-note">(7-14 days)</span></td>
            <td></td>
            <td></td>
            <td>X</td>
            <td>X</td>
          </tr>
          <tr>
            <td>Unlimited Scheduling<br><span class="feature-note">(16+ days or more)</span></td>
            <td></td>
            <td></td>
            <td></td>
            <td>X</td>
          </tr>
          <tr>
            <td>Basic Weather Integration<br><span class="feature-note">(Wind & Solar)</span></td>
            <td>X</td>
            <td>X</td>
            <td>X</td>
            <td>X</td>
          </tr>
          <tr>
            <td>Advanced Weather Integration<br><span class="feature-note">(Extended Forecast)</span></td>
            <td></td>
            <td>X</td>
            <td>X</td>
            <td>X</td>
          </tr>
          <tr>
            <td>Minute-level Scheduling<br><span class="feature-note">(Plan in minutes instead of hours)</span></td>
            <td></td>
            <td>X</td>
            <td>X</td>
            <td>X</td>
          </tr>
          <tr>
            <td>Weather Refresh Frequency<br><span class="feature-note">(Free/Standard: 1 hr; Professional/Enterprise: 1 min)</span></td>
            <td>1 hr</td>
            <td>1 hr</td>
            <td>1 min</td>
            <td>1 min / Custom</td>
          </tr>
          <tr>
            <td>AI-Driven Adaptive Scheduling</td>
            <td></td>
            <td></td>
            <td>X</td>
            <td>X</td>
          </tr>
          <tr>
            <td>Advanced Analytics & Reporting</td>
            <td></td>
            <td></td>
            <td>X</td>
            <td>X</td>
          </tr>
          <tr>
            <td>API Access for Integration</td>
            <td></td>
            <td></td>
            <td>X</td>
            <td>X</td>
          </tr>
          <tr>
            <td>Smart Plug Capacity<br><span class="feature-note">(Free: 3 / Standard: 10 / Professional: 50 / Enterprise: Unlimited)</span></td>
            <td>3</td>
            <td>10</td>
            <td>50</td>
            <td>Unlimited</td>
          </tr>
          <tr>
            <td>Integration with IFTTT / Home Assistant</td>
            <td></td>
            <td>X</td>
            <td>X</td>
            <td>X</td>
          </tr>
          <tr>
            <td>Basic Community Support</td>
            <td>X</td>
            <td></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td>Enhanced Support (Email/Chat)</td>
            <td></td>
            <td>X</td>
            <td>X</td>
            <td>X</td>
          </tr>
          <tr>
            <td>24/7 Dedicated Support & SLA</td>
            <td></td>
            <td></td>
            <td></td>
            <td>X</td>
          </tr>
          <tr>
            <td>White‑Label & Custom Branding</td>
            <td></td>
            <td></td>
            <td></td>
            <td>X</td>
          </tr>
          <tr>
            <td>Custom Integration & Consultation</td>
            <td></td>
            <td></td>
            <td></td>
            <td>X</td>
          </tr>
          <tr>
            <td>Volume Discounts & Tailored Procurement</td>
            <td></td>
            <td></td>
            <td></td>
            <td>X</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Overview Sections (at the bottom) -->
    <div class="mt-5">
      <div class="row">
        <div class="col-md-3">
          <button class="btn btn-info btn-block overview-button" data-toggle="collapse" data-target="#dashboardOverview" aria-expanded="false" aria-controls="dashboardOverview">This Dashboard</button>
          <div class="collapse" id="dashboardOverview">
            <div class="overview-card">
              <h5>This Dashboard</h5>
              <p>
                Our dashboard integrates real-time weather forecasts with smart plug scheduling. Monitor renewable energy trends and see how your devices are optimized.
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <button class="btn btn-info btn-block overview-button" data-toggle="collapse" data-target="#profitOverview" aria-expanded="false" aria-controls="profitOverview">Your Profits</button>
          <div class="collapse" id="profitOverview">
            <div class="overview-card">
              <h5>Your Profits</h5>
              <p>
                Compare your planned and optimized schedules to track energy savings and cost reductions, helping you see the benefits of smart scheduling.
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <button class="btn btn-info btn-block overview-button" data-toggle="collapse" data-target="#recommendedDevices" aria-expanded="false" aria-controls="recommendedDevices">Recommended Devices</button>
          <div class="collapse" id="recommendedDevices">
            <div class="overview-card">
              <h5>Recommended Devices</h5>
              <p>These devices are ideal candidates for weather-based smart plugs – devices that already cycle on and off during the day but don’t yet adjust based on renewable energy availability:</p>
              <ul>
                <li>Standard Air Conditioners</li>
                <li>Home Battery Systems</li>
                <li>Electric Vehicle Chargers</li>
                <li>Refrigerators/Freezers</li>
                <li>Water Heaters</li>
                <li>Sump Pumps</li>
                <li>Hot Tubs/Spas</li>
                <li>Heated Floors</li>
                <li>Air Purifiers</li>
                <li>Dehumidifiers/Humidifiers</li>
                <li>Electric Space Heaters</li>
                <li>Fans</li>
                <li>Fridges</li>
                <li>Fish Tank Heaters, Pumps and Filters</li>
                <li>Industrial Equipment</li>
                <li>Electric Water Pumps</li>
                <li>Irrigation Systems</li>
                <li>Pool Pumps</li>
                <li><a href="https://unboundsolar.com/solar-information/power-table?srsltid=AfmBOorWqW1Nq55yEx8AOuI2x0OWv-94g1V12WiayllWSbAY6vb7hG01" target="_blank">etc.</a></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <button class="btn btn-info btn-block overview-button" data-toggle="collapse" data-target="#userGuide" aria-expanded="false" aria-controls="userGuide">User Guide</button>
          <div class="collapse" id="userGuide">
            <div class="overview-card">
              <h5>User Guide</h5>
              <ol>
                <li>Set Your Location</li>
                <li>Retrieve Weather</li>
                <li>Adjust Energy Slider</li>
                <li>Add Your Smart Plug</li>
                <li>Select Schedule Type</li>
                <li>Review Profit Forecast</li>
                <li>Save/Load Settings</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Extra bottom space -->
    <div style="height: 100px;"></div>
    
  </div>
  
  <!-- jQuery and Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script>
    // Initialize tooltips
    $(function () {
      $('[data-toggle="tooltip"]').tooltip();
    });
    
    // Auto-scroll for expanded overview sections
    $('.collapse').on('shown.bs.collapse', function () {
      $('html, body').animate({
        scrollTop: $(this).offset().top - 50
      }, 800);
    });
    
    /*************************************
     * GLOBAL VARIABLES & TIMER SETUP
     *************************************/
    let weatherTimeData = null,
        weatherWindData = null,
        weatherUvData = null,
        globalLineTraces = [],
        globalMergedLayout = null,
        lastWeatherUpdate = null,
        chartInitialized = false;
    
    // Timer for forecast refresh countdown
    function updateTimer() {
      const now = new Date();
      const nextHour = new Date(now);
      nextHour.setMinutes(0, 0, 0);
      nextHour.setHours(now.getHours() + 1);
      const diff = nextHour - now;
      const seconds = Math.floor(diff / 1000) % 60;
      const minutes = Math.floor(diff / (1000 * 60)) % 60;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      document.getElementById('refreshTimer').innerText =
        (hours < 10 ? "0" + hours : hours) + ":" +
        (minutes < 10 ? "0" + minutes : minutes) + ":" +
        (seconds < 10 ? "0" + seconds : seconds);
    }
    setInterval(updateTimer, 1000);
    updateTimer();
    
    /**************************************
     * SAVE/LOAD SETTINGS FROM STORAGE
     **************************************/
    function saveSettings() {
      const settings = {
        manualLocation: document.getElementById('manualLocation').value,
        energySlider: document.getElementById('energySlider').value,
        scheduleType: document.querySelector('input[name="scheduleType"]:checked').value,
        plugs: []
      };
      const plugEntries = document.querySelectorAll('.plugEntry');
      plugEntries.forEach(entry => {
        const plug = {
          name: entry.querySelector('.plugName').value,
          onHours: entry.querySelector('.plugOnHours').value,
          totalHours: entry.querySelector('.plugTotalHours').value,
          kwh: entry.querySelector('.plugKwh').value,
          webhookOn: entry.querySelector('.webhookOn').value,
          webhookOff: entry.querySelector('.webhookOff').value,
          forcedRules: []
        };
        entry.querySelectorAll('.forcedRule').forEach(rule => {
          const daysSelect = rule.querySelector('.forcedRuleDays');
          const selectedDays = Array.from(daysSelect.selectedOptions).map(opt => opt.value);
          plug.forcedRules.push({
            days: selectedDays,
            start: rule.querySelector('.forcedRuleStart').value,
            end: rule.querySelector('.forcedRuleEnd').value,
            state: rule.querySelector('.forcedRuleState').value
          });
        });
        settings.plugs.push(plug);
      });
      localStorage.setItem("dashboardSettings", JSON.stringify(settings));
      alert("Settings saved.");
    }
    
    function loadSettings() {
      const settingsStr = localStorage.getItem("dashboardSettings");
      if (!settingsStr) { alert("No settings found."); return; }
      const settings = JSON.parse(settingsStr);
      document.getElementById('manualLocation').value = settings.manualLocation;
      document.getElementById('energySlider').value = settings.energySlider;
      document.getElementById('sunWeightLabel').textContent = settings.energySlider;
      document.getElementById('windWeightLabel').textContent = 100 - settings.energySlider;
      document.querySelector(`input[name="scheduleType"][value="${settings.scheduleType}"]`).checked = true;
      const plugList = document.getElementById('plugList');
      plugList.innerHTML = "";
      settings.plugs.forEach((plug) => { addPlug(plug); });
      alert("Settings loaded.");
      document.getElementById("locationForm").dispatchEvent(new Event('submit'));
    }
    
    document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
    document.getElementById('loadSettingsBtn').addEventListener('click', loadSettings);
    
    /****************************************
     * GEOLOCATION & WEATHER RETRIEVAL
     ****************************************/
    function setLocationDisplay(data, latitude, longitude) {
      const address = data.address || {};
      const place = address.city || address.town || address.village || address.hamlet || "";
      let displayText = `Your coordinates: Latitude: ${latitude.toFixed(4)}, Longitude: ${longitude.toFixed(4)}`;
      if (place) { displayText += `<br>Location: ${place}`; }
      if (address.country) { displayText += `<br>Country: ${address.country}`; }
      document.getElementById('locationDisplay').innerHTML = `<p>${displayText}</p>`;
      const manualField = document.getElementById('manualLocation');
      if (place) { 
        manualField.value = place; 
        document.getElementById("locationForm").dispatchEvent(new Event('submit'));
      }
    }
    
    function getGeoLocation() {
      const locationDisplay = document.getElementById('locationDisplay');
      locationDisplay.innerHTML = '<p>Retrieving your location...</p>';
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            const reverseUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&addressdetails=1`;
            fetch(reverseUrl)
              .then(response => response.json())
              .then(data => { 
                setLocationDisplay(data, latitude, longitude);
              })
              .catch(error => { 
                locationDisplay.innerHTML = `<p>Your coordinates: Latitude: ${latitude.toFixed(4)}, Longitude: ${longitude.toFixed(4)}. Reverse geocoding failed. Please enter your location manually.</p>`; 
              });
          },
          function(error) {
            locationDisplay.innerHTML = `<p>Error getting location: ${error.message}. Please enter your location manually.</p>`;
          }
        );
      } else {
        locationDisplay.innerHTML = '<p>Geolocation is not supported by this browser. Please enter your location manually.</p>';
      }
    }
    
    document.getElementById('getGeoBtn').addEventListener('click', getGeoLocation);
    
    document.getElementById('locationForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const locationName = document.getElementById('manualLocation').value;
      const manualLocationResult = document.getElementById('manualLocationResult');
      manualLocationResult.innerHTML = '<p>Converting location to coordinates...</p>';
      const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=1&q=${encodeURIComponent(locationName)}`;
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data && data.length > 0) {
            const lat = data[0].lat;
            const lon = data[0].lon;
            const country = (data[0].address && data[0].address.country) ? data[0].address.country : '';
            manualLocationResult.innerHTML = `<p>Coordinates for ${locationName}: Latitude: ${parseFloat(lat).toFixed(4)}, Longitude: ${parseFloat(lon).toFixed(4)}${country ? `<br>Country: ${country}` : ""}</p>`;
            const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=uv_index,wind_speed_80m&forecast_days=3&past_days=1&timezone=Europe%2FAmsterdam&location_mode=csv_coordinates`;
            fetch(weatherUrl)
              .then(response => response.json())
              .then(weatherData => {
                if (weatherData && weatherData.hourly && weatherData.hourly.time) {
                  weatherTimeData = weatherData.hourly.time;
                  weatherWindData = weatherData.hourly.wind_speed_80m;
                  weatherUvData = weatherData.hourly.uv_index;
                  lastWeatherUpdate = new Date();
                  const traceWind = {
                    x: weatherTimeData,
                    y: weatherWindData,
                    mode: 'lines',
                    name: 'Wind Speed at 80m (m/s)',
                    yaxis: 'y1'
                  };
                  const traceSun = {
                    x: weatherTimeData,
                    y: weatherUvData,
                    mode: 'lines',
                    name: 'Sun radiation',
                    yaxis: 'y2'
                  };
                  const weight = parseInt(document.getElementById('energySlider').value, 10) / 100;
                  const computeRenewable = w => weatherTimeData.map((_, i) => w * parseFloat(weatherUvData[i]) + (1 - w) * parseFloat(weatherWindData[i]));
                  const traceRenewable = {
                    x: weatherTimeData,
                    y: computeRenewable(weight),
                    mode: 'lines',
                    name: 'Renewable Energy Quality',
                    yaxis: 'y3'
                  };
                  globalLineTraces = [traceWind, traceSun, traceRenewable];
                  
                  globalMergedLayout = {
                    paper_bgcolor: '#ffffff',
                    plot_bgcolor: '#ffffff',
                    font: { color: '#333', family: 'Roboto, sans-serif', size: 10 },
                    title: {
                      text: 'Forecast, Renewable Energy & Plug Schedule (Toggle traces via legend)',
                      font: { size: 12, color: '#333', family: 'Roboto, sans-serif' }
                    },
                    xaxis: { 
                      title: 'Time',
                      tickangle: -45,
                      automargin: true,
                      tickfont: { size: 12 },
                      rangeselector: {
                        bgcolor: '#e0e0e0',
                        activecolor: '#007bff',
                        font: { color: '#333', size: 10 },
                        buttons: [
                          {count: 6, label: '6h', step: 'hour', stepmode: 'backward'},
                          {count: 12, label: '12h', step: 'hour', stepmode: 'backward'},
                          {count: 1, label: '1d', step: 'day', stepmode: 'backward'},
                          {step: 'all'}
                        ]
                      },
                      rangeslider: {}
                    },
                    yaxis: {
                      title: 'Wind Speed (m/s)',
                      automargin: true,
                      title_standoff: 10,
                      tickfont: { size: 9 }
                    },
                    yaxis2: {
                      title: 'Sun radiation',
                      overlaying: 'y',
                      side: 'right',
                      automargin: true,
                      title_standoff: 10,
                      tickfont: { size: 9 }
                    },
                    yaxis3: {
                      title: 'Renewable Energy Score',
                      anchor: 'free',
                      overlaying: 'y',
                      side: 'left',
                      position: 0.04,
                      automargin: true,
                      title_standoff: 10,
                      tickfont: { size: 9 }
                    },
                    legend: {
                      orientation: 'v',
                      x: 1.02,
                      y: 1,
                      xanchor: 'left',
                      font: { size: 9 },
                      bgcolor: '#ffffff'
                    },
                    barmode: 'stack',
                    hovermode: 'closest',
                    height: 400,
                    margin: { l: 50, r: 100, t: 60, b: 70 }
                  };
                  
                  if (chartInitialized) {
                    Plotly.react('mergedGraph', globalLineTraces, globalMergedLayout, { responsive: true });
                  } else {
                    Plotly.newPlot('mergedGraph', globalLineTraces, globalMergedLayout, { responsive: true });
                    chartInitialized = true;
                  }
                  if(document.getElementById('plugList').children.length === 0){
                    addPlug();
                  }
                  updatePlugSchedules();
                  checkPlugStates();
                  updateProfitInfographic();
                } else {
                  document.getElementById('mergedGraph').innerHTML = '<p>No weather data available for the selected period.</p>';
                }
              })
              .catch(error => { document.getElementById('mergedGraph').innerHTML = `<p>Error fetching weather data: ${error.message}</p>`; });
          } else {
            manualLocationResult.innerHTML = `<p>No results found for "${locationName}".</p>`;
          }
        })
        .catch(error => { manualLocationResult.innerHTML = `<p>Error converting location: ${error.message}</p>`; });
    });
    
    /*******************************************
     * ENERGY SLIDER & PLUG SCHEDULE UPDATE
     *******************************************/
    document.getElementById('energySlider').addEventListener('input', function() {
      const sliderValue = parseInt(this.value, 10);
      document.getElementById('sunWeightLabel').textContent = sliderValue;
      document.getElementById('windWeightLabel').textContent = 100 - sliderValue;
      const r = Math.round((sliderValue / 100) * 255);
      const g = Math.round((sliderValue / 100) * 255);
      const b = Math.round(255 - (sliderValue / 100) * 255);
      const thumbColor = `rgb(${r},${g},${b})`;
      this.style.setProperty('--thumb-color', thumbColor);
      this.style.background = `linear-gradient(to right, ${thumbColor} 0%, ${thumbColor} 100%)`;
      if (!weatherTimeData || !weatherWindData || !weatherUvData) return;
      const weight = sliderValue / 100;
      const newRenewable = weatherTimeData.map((_, i) => weight * parseFloat(weatherUvData[i]) + (1 - weight) * parseFloat(weatherWindData[i]));
      Plotly.restyle('mergedGraph', { y: [newRenewable] }, [2]);
      if (document.querySelector('input[name="scheduleType"]:checked').value === "optimized") {
        updatePlugSchedules();
        checkPlugStates();
        updateProfitInfographic();
      }
    });
    
    // Set initial slider track color on page load
    window.addEventListener("load", function() {
      var slider = document.getElementById('energySlider');
      var initialValue = parseInt(slider.value, 10);
      const r = Math.round((initialValue / 100) * 255);
      const g = Math.round((initialValue / 100) * 255);
      const b = Math.round(255 - (initialValue / 100) * 255);
      const thumbColor = `rgb(${r},${g},${b})`;
      slider.style.setProperty('--thumb-color', thumbColor);
      slider.style.background = `linear-gradient(to right, ${thumbColor} 0%, ${thumbColor} 100%)`;
    });
    
    document.querySelectorAll('input[name="scheduleType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        updatePlugSchedules();
        checkPlugStates();
        updateProfitInfographic();
      });
    });
    
    function groupTimesByDay(timeData) {
      const groups = {};
      timeData.forEach((t, i) => {
        let date = t.split("T")[0];
        if (!groups[date]) groups[date] = { times: [], indices: [] };
        groups[date].times.push(t);
        groups[date].indices.push(i);
      });
      const sortedDates = Object.keys(groups).sort();
      return sortedDates.map(date => groups[date]);
    }
    
    function computePlugScheduleForDay(onHours, totalHours, dayTimes) {
      const dayLength = dayTimes.length;
      function computeCycle(onHours, totalHours) {
        onHours = Math.min(onHours, totalHours);
        let pattern = new Array(totalHours).fill(0);
        let positions = [];
        for (let i = 0; i < onHours; i++) {
          let pos = Math.round((i + 0.5) * totalHours / onHours - 0.5);
          if (pos < 0) pos = 0;
          if (pos >= totalHours) pos = totalHours - 1;
          positions.push(pos);
        }
        positions.forEach(p => { pattern[p] = 1; });
        return pattern;
      }
      const cycle = computeCycle(onHours, totalHours);
      let schedule = [];
      const cycles = Math.floor(dayLength / totalHours);
      const remainder = dayLength % totalHours;
      for (let i = 0; i < cycles; i++) { schedule = schedule.concat(cycle); }
      schedule = schedule.concat(cycle.slice(0, remainder));
      return schedule;
    }
    
    function computeOptimalPlugScheduleForDay(onHours, totalHours, dayGroup, weight) {
      const dayTimes = dayGroup.times;
      const indices = dayGroup.indices;
      const dayLength = dayTimes.length;
      let schedule = [];
      const cycles = Math.floor(dayLength / totalHours);
      const remainder = dayLength % totalHours;
      // Process full cycles using quality-based scheduling.
      for (let c = 0; c < cycles; c++) {
        const cycleIndices = indices.slice(c * totalHours, (c + 1) * totalHours);
        const qualityCycle = cycleIndices.map(i => weight * parseFloat(weatherUvData[i]) + (1 - weight) * parseFloat(weatherWindData[i]));
        let pattern = new Array(totalHours).fill(0);
        let idxs = Array.from({ length: totalHours }, (_, idx) => idx);
        idxs.sort((a, b) => qualityCycle[b] - qualityCycle[a]);
        for (let k = 0; k < onHours; k++) { pattern[idxs[k]] = 1; }
        schedule = schedule.concat(pattern);
      }
      if (remainder > 0) {
        // For partial cycle, mimic the user planned schedule.
        function computeCycle(onHours, totalHours) {
          onHours = Math.min(onHours, totalHours);
          let pattern = new Array(totalHours).fill(0);
          let positions = [];
          for (let i = 0; i < onHours; i++) {
            let pos = Math.round((i + 0.5) * totalHours / onHours - 0.5);
            if (pos < 0) pos = 0;
            if (pos >= totalHours) pos = totalHours - 1;
            positions.push(pos);
          }
          positions.forEach(p => { pattern[p] = 1; });
          return pattern;
        }
        let userCyclePattern = computeCycle(onHours, totalHours);
        let remainderPattern = userCyclePattern.slice(0, remainder);
        schedule = schedule.concat(remainderPattern);
      }
      return schedule;
    }
    
    function applyForcedRules(entry, schedule) {
      const forcedRules = entry.querySelectorAll('.forcedRule');
      forcedRules.forEach(rule => {
        const daysSelect = rule.querySelector('.forcedRuleDays');
        const selectedDays = Array.from(daysSelect.selectedOptions).map(opt => opt.value);
        const startTime = rule.querySelector('.forcedRuleStart').value;
        const endTime = rule.querySelector('.forcedRuleEnd').value;
        const forcedState = rule.querySelector('.forcedRuleState').value;
        schedule = schedule.map((val, index) => {
          const ts = new Date(weatherTimeData[index]);
          const dayName = ts.toLocaleDateString('en-US', { weekday: 'short' });
          if (!selectedDays.includes(dayName)) return val;
          const minutes = ts.getHours() * 60 + ts.getMinutes();
          const [startH, startM] = startTime.split(':').map(Number);
          const [endH, endM] = endTime.split(':').map(Number);
          const startMinutes = startH * 60 + startM;
          const endMinutes = endH * 60 + endM;
          let inInterval = (startMinutes <= endMinutes)
                          ? (minutes >= startMinutes && minutes < endMinutes)
                          : (minutes >= startMinutes || minutes < endMinutes);
          if (inInterval) return forcedState === "on" ? 1 : 0;
          return val;
        });
      });
      return schedule;
    }
    
    function addPlug(plugData = null) {
      const plugList = document.getElementById('plugList');
      const plugIndex = plugList.children.length + 1;
      const plugDiv = document.createElement('div');
      plugDiv.className = 'plugEntry';
      plugDiv.innerHTML = `
        <div class="form-group">
          <input type="text" class="form-control plugName" placeholder="Plug Name" value="${plugData ? plugData.name : "Plug " + plugIndex}" title="Enter a unique name for this plug.">
          <small class="form-text">Enter a unique name for this smart plug.</small>
        </div>
        <div class="form-row">
          <div class="col">
            <input type="number" class="form-control plugOnHours" placeholder="On Hours" min="1" max="24" step="1" value="${plugData ? plugData.onHours : 3}" title="Enter hours this plug should be ON per cycle (1-24, whole hours only).">
            <small class="form-text">On Hours per cycle (1-24, whole hours).</small>
          </div>
          <div class="col">
            <input type="number" class="form-control plugTotalHours" placeholder="Total Hours" min="1" max="24" step="1" value="${plugData ? plugData.totalHours : 6}" title="Enter total hours in each cycle (1-24, whole hours only).">
            <small class="form-text">Total Hours per cycle (1-24, whole hours).</small>
          </div>
          <div class="col">
            <input type="number" step="0.1" class="form-control plugKwh" placeholder="kWh" min="0" value="${plugData ? plugData.kwh : 1.5}" title="Enter device power consumption in kWh.">
            <small class="form-text">Power consumption in kWh when ON (e.g., 1.5).</small>
          </div>
        </div>
        <div class="form-group mt-2">
          <input type="text" class="form-control webhookOn" placeholder="Webhook URL for ON" value="${plugData ? plugData.webhookOn : ""}">
          <small class="form-text">
            A webhook is a simple internet request that tells your smart plug to turn <strong>ON</strong>.
            You can set this up using services like 
            <a href="https://ifttt.com/maker_webhooks" target="_blank" style="color: #007bff; text-decoration: underline;">IFTTT Webhooks</a> or 
            <a href="https://www.home-assistant.io/integrations/webhook/" target="_blank" style="color: #007bff; text-decoration: underline;">Home Assistant</a>.
          </small>
          <button type="button" class="btn btn-sm btn-secondary testWebhookOn mt-1" title="Click to test the ON webhook.">Test ON Webhook</button>
        </div>
        <div class="form-group">
          <input type="text" class="form-control webhookOff" placeholder="Webhook URL for OFF" value="${plugData ? plugData.webhookOff : ""}">
          <small class="form-text">
            A webhook is a simple internet request that tells your smart plug to turn <strong>OFF</strong>.
            You can set this up using services like 
            <a href="https://ifttt.com/maker_webhooks" target="_blank" style="color: #007bff; text-decoration: underline;">IFTTT Webhooks</a> or 
            <a href="https://www.home-assistant.io/integrations/webhook/" target="_blank" style="color: #007bff; text-decoration: underline;">Home Assistant</a>.
          </small>
          <button type="button" class="btn btn-sm btn-secondary testWebhookOff mt-1" title="Click to test the OFF webhook.">Test OFF Webhook</button>
        </div>
        <button type="button" class="btn btn-danger btn-sm deletePlug" title="Remove this plug configuration.">Delete Plug</button>
        <div class="plugStatus" style="margin-top:5px;">Status: UNKNOWN</div>
        <button class="btn btn-sm btn-info mt-2 toggleAdvancedSettings" type="button" data-toggle="collapse" data-target="#advancedSettings-${plugIndex}" title="Toggle advanced settings for this plug.">Toggle Advanced Settings</button>
        <div class="collapse plugAdvancedSettings" id="advancedSettings-${plugIndex}">
          <div class="forcedScheduleSection mt-2">
            <h5>Forced Schedule Settings</h5>
            <div class="forcedRulesContainer"></div>
            <button type="button" class="btn btn-secondary btn-sm addForcedRule" title="Add a forced rule for this plug.">Add Forced Rule</button>
            <small class="form-text">Define forced on/off rules (only whole hours allowed).</small>
          </div>
          <div class="historyLogSection mt-3">
            <h5>History Log</h5>
            <!-- Instead of one table, we use a container that will hold collapsible tables grouped by date -->
            <div class="historyLogTableContainer"></div>
          </div>
        </div>
      `;
      plugList.appendChild(plugDiv);
      
      plugDiv.historyLog = [];
      
      // Helper function to add a log entry and update the history table
      function addLog(entry) {
        plugDiv.historyLog.push(entry);
        updateHistoryTable(plugDiv);
      }
      
      plugDiv.querySelector('.deletePlug').addEventListener('click', function() {
        plugList.removeChild(plugDiv);
      });
      
      plugDiv.querySelector('.testWebhookOn').addEventListener('click', function() {
        const webhook = plugDiv.querySelector('.webhookOn').value;
        if (webhook) { 
          const img = new Image(); 
          img.src = webhook; 
          console.log("Triggered webhook ON: " + webhook);
          addLog({ time: new Date().toLocaleTimeString(), date: new Date().toLocaleDateString(), state: "ON", timestamp: new Date().getTime() });
        } else { 
          alert("Please enter a webhook URL for ON"); 
        }
      });
      
      plugDiv.querySelector('.testWebhookOff').addEventListener('click', function() {
        const webhook = plugDiv.querySelector('.webhookOff').value;
        if (webhook) { 
          const img = new Image(); 
          img.src = webhook; 
          console.log("Triggered webhook OFF: " + webhook);
          addLog({ time: new Date().toLocaleTimeString(), date: new Date().toLocaleDateString(), state: "OFF", timestamp: new Date().getTime() });
        } else { 
          alert("Please enter a webhook URL for OFF"); 
        }
      });
      
      plugDiv.querySelector('.addForcedRule').addEventListener('click', function() {
        const container = plugDiv.querySelector('.forcedRulesContainer');
        const ruleDiv = document.createElement('div');
        ruleDiv.className = 'forcedRule row';
        ruleDiv.innerHTML = `
          <div class="col-4">
            <label>Days:</label>
            <select class="form-control forcedRuleDays" multiple size="3" title="Select the days this rule applies to.">
              <option value="Mon">Mon</option>
              <option value="Tue">Tue</option>
              <option value="Wed">Wed</option>
              <option value="Thu">Thu</option>
              <option value="Fri">Fri</option>
              <option value="Sat">Sat</option>
              <option value="Sun">Sun</option>
            </select>
          </div>
          <div class="col-3">
            <label>Start Time:</label>
            <input type="time" class="form-control forcedRuleStart" value="08:00" step="3600" title="Set the start time (whole hours only).">
          </div>
          <div class="col-3">
            <label>End Time:</label>
            <input type="time" class="form-control forcedRuleEnd" value="09:00" step="3600" title="Set the end time (whole hours only).">
          </div>
          <div class="col-2">
            <label>State:</label>
            <select class="form-control forcedRuleState" title="Choose whether to force the plug ON or OFF during this time interval.">
              <option value="on">ON</option>
              <option value="off">OFF</option>
            </select>
          </div>
          <div class="col-12">
            <button type="button" class="btn btn-danger btn-sm removeForcedRule mt-1" title="Remove this rule.">Remove Rule</button>
          </div>
        `;
        container.appendChild(ruleDiv);
        ruleDiv.querySelector('.removeForcedRule').addEventListener('click', function() { container.removeChild(ruleDiv); });
      });
      
      $(`#advancedSettings-${plugIndex}`).on('shown.bs.collapse', function () { updateHistoryTable(plugDiv); });
      
      if (plugData && plugData.forcedRules) {
        plugData.forcedRules.forEach(rule => {
          const container = plugDiv.querySelector('.forcedRulesContainer');
          const ruleDiv = document.createElement('div');
          ruleDiv.className = 'forcedRule row';
          ruleDiv.innerHTML = `
            <div class="col-4">
              <label>Days:</label>
              <select class="form-control forcedRuleDays" multiple size="3" title="Select the days this rule applies to.">
                <option value="Mon">Mon</option>
                <option value="Tue">Tue</option>
                <option value="Wed">Wed</option>
                <option value="Thu">Thu</option>
                <option value="Fri">Fri</option>
                <option value="Sat">Sat</option>
                <option value="Sun">Sun</option>
              </select>
            </div>
            <div class="col-3">
              <label>Start Time:</label>
              <input type="time" class="form-control forcedRuleStart" value="${rule.start}" step="3600" title="Start time (whole hours only).">
            </div>
            <div class="col-3">
              <label>End Time:</label>
              <input type="time" class="form-control forcedRuleEnd" value="${rule.end}" step="3600" title="End time (whole hours only).">
            </div>
            <div class="col-2">
              <label>State:</label>
              <select class="form-control forcedRuleState" title="Force the plug ON or OFF during this period.">
                <option value="on" ${rule.state === "on" ? "selected" : ""}>ON</option>
                <option value="off" ${rule.state === "off" ? "selected" : ""}>OFF</option>
              </select>
            </div>
            <div class="col-12">
              <button type="button" class="btn btn-danger btn-sm removeForcedRule mt-1" title="Remove this rule.">Remove Rule</button>
            </div>
          `;
          container.appendChild(ruleDiv);
          ruleDiv.querySelector('.removeForcedRule').addEventListener('click', function() { container.removeChild(ruleDiv); });
        });
      }
      
      // Listen for immediate changes on plug settings.
      plugDiv.addEventListener('input', function() {
        updatePlugSchedules();
        checkPlugStates();
        updateProfitInfographic();
      });
      plugDiv.addEventListener('change', function() {
        updatePlugSchedules();
        checkPlugStates();
        updateProfitInfographic();
      });
    }
    
    document.getElementById('addPlugBtn').addEventListener('click', function() { addPlug(); });
    
    // Update history log grouped by date.
    function updateHistoryTable(plugEntry) {
      const container = plugEntry.querySelector('.historyLogTableContainer');
      container.innerHTML = "";
      const logs = plugEntry.historyLog;
      if (!logs || logs.length === 0) {
        container.innerHTML = "<p>No history available.</p>";
        return;
      }
      // Group logs by date.
      const logsByDate = {};
      logs.forEach(log => {
        if (!logsByDate[log.date]) logsByDate[log.date] = [];
        logsByDate[log.date].push(log);
      });
      const sortedDates = Object.keys(logsByDate).sort();
      sortedDates.forEach(date => {
        const header = document.createElement('div');
        header.className = "logDateHeader";
        header.textContent = date;
        // Create a table for logs of this date.
        const table = document.createElement('table');
        table.className = "table table-sm";
        const thead = document.createElement('thead');
        thead.innerHTML = "<tr><th>Time</th><th>Status</th><th>Duration</th></tr>";
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        const dayLogs = logsByDate[date];
        for (let i = 0; i < dayLogs.length; i++) {
          let durationText = "";
          if (i < dayLogs.length - 1) {
            const diff = dayLogs[i + 1].timestamp - dayLogs[i].timestamp;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            durationText = `${hours}h ${minutes}m`;
          }
          const row = document.createElement('tr');
          row.innerHTML = `<td>${dayLogs[i].time}</td><td>${dayLogs[i].state}</td><td>${durationText}</td>`;
          tbody.appendChild(row);
        }
        table.appendChild(tbody);
        // Initially collapse the table.
        table.style.display = "none";
        header.addEventListener('click', function() {
          table.style.display = (table.style.display === "none") ? "table" : "none";
        });
        container.appendChild(header);
        container.appendChild(table);
      });
    }
    
    function updatePlugSchedules() {
      if (!weatherTimeData) { alert("Weather data not available yet."); return; }
      const dayGroups = groupTimesByDay(weatherTimeData);
      const plugEntries = document.querySelectorAll('.plugEntry');
      let plugTraces = [];
      let optimalPlugTraces = [];
      const currentWeight = parseInt(document.getElementById('energySlider').value, 10) / 100;
      plugEntries.forEach(entry => {
        const name = entry.querySelector('.plugName').value || "Unnamed Plug";
        const onHours = parseInt(entry.querySelector('.plugOnHours').value, 10);
        const totalHours = parseInt(entry.querySelector('.plugTotalHours').value, 10);
        const kwh = parseFloat(entry.querySelector('.plugKwh').value);
        let uniformSchedule = [];
        let optimalSchedule = [];
        dayGroups.forEach(group => {
          const dayUniform = computePlugScheduleForDay(onHours, totalHours, group.times);
          const dayOptimal = computeOptimalPlugScheduleForDay(onHours, totalHours, group, currentWeight);
          uniformSchedule = uniformSchedule.concat(dayUniform);
          optimalSchedule = optimalSchedule.concat(dayOptimal);
        });
        uniformSchedule = applyForcedRules(entry, uniformSchedule);
        optimalSchedule = applyForcedRules(entry, optimalSchedule);
        const traceUniform = {
          x: weatherTimeData,
          y: uniformSchedule.map(val => val * kwh),
          type: 'bar',
          name: name,
          marker: { opacity: 0.7 }
        };
        const traceOptimal = {
          x: weatherTimeData,
          y: optimalSchedule.map(val => val * kwh),
          type: 'bar',
          name: "Optimal: " + name,
          marker: { opacity: 0.7, color: 'blue' }
        };
        plugTraces.push(traceUniform);
        optimalPlugTraces.push(traceOptimal);
      });
      const scheduleType = document.querySelector('input[name="scheduleType"]:checked').value;
      const selectedPlugTraces = (scheduleType === "user") ? plugTraces : optimalPlugTraces;
      const allTraces = globalLineTraces.concat(selectedPlugTraces);
      globalMergedLayout.barmode = 'stack';
      if (chartInitialized) {
        Plotly.react('mergedGraph', allTraces, globalMergedLayout, { responsive: true });
      } else {
        Plotly.newPlot('mergedGraph', allTraces, globalMergedLayout, { responsive: true });
        chartInitialized = true;
      }
    }
    
    function updateProfitInfographic() {
      if (!weatherTimeData) return;
      const dayGroups = groupTimesByDay(weatherTimeData);
      let totalRescheduledEnergy = 0;
      const plugEntries = document.querySelectorAll('.plugEntry');
      plugEntries.forEach(entry => {
        const kwh = parseFloat(entry.querySelector('.plugKwh').value);
        const onHours = parseInt(entry.querySelector('.plugOnHours').value, 10);
        const totalHours = parseInt(entry.querySelector('.plugTotalHours').value, 10);
        let plugRescheduled = 0;
        dayGroups.forEach(group => {
          const userSched = computePlugScheduleForDay(onHours, totalHours, group.times);
          const optSched = computeOptimalPlugScheduleForDay(onHours, totalHours, group, parseInt(document.getElementById('energySlider').value, 10) / 100);
          const userFinal = applyForcedRules(entry, userSched);
          const optFinal = applyForcedRules(entry, optSched);
          let diffCount = 0;
          for (let i = 0; i < userFinal.length; i++) {
            if (userFinal[i] !== optFinal[i]) diffCount++;
          }
          plugRescheduled += (diffCount / 2) * kwh;
        });
        totalRescheduledEnergy += plugRescheduled;
      });
      document.getElementById('profitInfographicValue').innerHTML = `<p>${totalRescheduledEnergy.toFixed(2)} kWh</p>`;
    }
    
    function checkPlugStates() {
      try {
        if (!weatherTimeData) return;
        const now = new Date();
        let currentIndex = 0;
        let minDiff = Infinity;
        weatherTimeData.forEach((t, i) => {
          const diff = Math.abs(new Date(t) - now);
          if (diff < minDiff) { minDiff = diff; currentIndex = i; }
        });
        const plugEntries = document.querySelectorAll('.plugEntry');
        plugEntries.forEach((entry, idx) => {
          const scheduleType = document.querySelector('input[name="scheduleType"]:checked').value;
          const currentWeight = parseInt(document.getElementById('energySlider').value, 10) / 100;
          const onHours = parseInt(entry.querySelector('.plugOnHours').value, 10);
          const totalHours = parseInt(entry.querySelector('.plugTotalHours').value, 10);
          const dayGroups = groupTimesByDay(weatherTimeData);
          let schedule = [];
          dayGroups.forEach(group => {
            if (scheduleType === "user") {
              schedule = schedule.concat(computePlugScheduleForDay(onHours, totalHours, group.times));
            } else {
              schedule = schedule.concat(computeOptimalPlugScheduleForDay(onHours, totalHours, group, currentWeight));
            }
          });
          schedule = applyForcedRules(entry, schedule);
          const desiredState = schedule[currentIndex] === 1;
          const lastState = entry.dataset.state;
          const newState = desiredState ? "on" : "off";
          if (lastState !== newState) {
            if (newState === "on") {
              const webhook = entry.querySelector('.webhookOn').value;
              if (webhook) { 
                const img = new Image(); 
                img.src = webhook; 
                console.log("Triggered webhook ON for plug", idx, webhook);
              }
            } else {
              const webhook = entry.querySelector('.webhookOff').value;
              if (webhook) { 
                const img = new Image(); 
                img.src = webhook; 
                console.log("Triggered webhook OFF for plug", idx, webhook);
              }
            }
            entry.dataset.state = newState;
            // Log the automatic state change (with date included)
            entry.historyLog.push({ time: new Date().toLocaleTimeString(), date: new Date().toLocaleDateString(), state: newState.toUpperCase(), timestamp: new Date().getTime() });
            if (entry.historyLog.length > 50) entry.historyLog.shift();
            updateHistoryTable(entry);
          }
          const statusIndicator = entry.querySelector('.plugStatus');
          if (statusIndicator) { statusIndicator.innerText = "Status: " + newState.toUpperCase(); }
        });
      } catch (error) {
        console.error("Error in checkPlugStates:", error);
      }
    }
    
    setInterval(function() { 
      try {
        checkPlugStates(); 
      } catch (error) {
        console.error("Error in periodic plug state check:", error);
      }
    }, 10000);
    
    function refreshWeather() {
      document.getElementById("locationForm").dispatchEvent(new Event('submit'));
    }
    setInterval(function(){
      try {
        refreshWeather();
      } catch (error) {
        console.error("Error in hourly weather refresh:", error);
      }
    }, 3600000);
    
    setInterval(function() {
      try {
        if (lastWeatherUpdate && (new Date() - lastWeatherUpdate > 55 * 60 * 1000)) {
          console.log("Weather data outdated. Refreshing...");
          refreshWeather();
        }
      } catch (error) {
        console.error("Error in weather safety check:", error);
      }
    }, 60000);
    
    // Set initial slider track color on load
    window.addEventListener("load", function() {
      const slider = document.getElementById('energySlider');
      const initialValue = parseInt(slider.value, 10);
      const r = Math.round((initialValue / 100) * 255);
      const g = Math.round((initialValue / 100) * 255);
      const b = Math.round(255 - (initialValue / 100) * 255);
      const thumbColor = `rgb(${r},${g},${b})`;
      slider.style.setProperty('--thumb-color', thumbColor);
      slider.style.background = `linear-gradient(to right, ${thumbColor} 0%, ${thumbColor} 100%)`;
    });
    
    document.getElementById('energySlider').addEventListener('input', function() {
      const sliderValue = parseInt(this.value, 10);
      document.getElementById('sunWeightLabel').textContent = sliderValue;
      document.getElementById('windWeightLabel').textContent = 100 - sliderValue;
      const r = Math.round((sliderValue / 100) * 255);
      const g = Math.round((sliderValue / 100) * 255);
      const b = Math.round(255 - (sliderValue / 100) * 255);
      const thumbColor = `rgb(${r},${g},${b})`;
      this.style.setProperty('--thumb-color', thumbColor);
      this.style.background = `linear-gradient(to right, ${thumbColor} 0%, ${thumbColor} 100%)`;
      if (!weatherTimeData || !weatherWindData || !weatherUvData) return;
      const weight = sliderValue / 100;
      const newRenewable = weatherTimeData.map((_, i) => weight * parseFloat(weatherUvData[i]) + (1 - weight) * parseFloat(weatherWindData[i]));
      Plotly.restyle('mergedGraph', { y: [newRenewable] }, [2]);
      if (document.querySelector('input[name="scheduleType"]:checked').value === "optimized") {
        updatePlugSchedules();
        checkPlugStates();
        updateProfitInfographic();
      }
    });
    
    document.querySelectorAll('input[name="scheduleType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        updatePlugSchedules();
        checkPlugStates();
        updateProfitInfographic();
      });
    });
  </script>
</body>
</html>
