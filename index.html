<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Website Switcher - Airplane Dashboard</title>
  <!-- Import Bootstrap CSS for styling and collapse functionality -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Import Orbitron font for a futuristic look -->
  <link href="https://fonts.googleapis.com/css?family=Orbitron&display=swap" rel="stylesheet">
  <!-- Import Plotly for interactive graphs -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      background-color: #1a1a1a;
      color: #e0e0e0;
      font-family: 'Orbitron', sans-serif;
    }
    h1, h2, h3, h5 {
      color: #f0f0f0;
    }
    .container {
      margin-top: 20px;
    }
    /* Forecast and Smart Plug Settings take full width */
    #forecastSection, #smartPlugSettingsSection {
      margin-bottom: 40px;
    }
    /* Styling for the plug settings panel */
    #plugSchedulePanel {
      background: #2a2a2a;
      border: 1px solid #444;
      padding: 15px;
      border-radius: 5px;
    }
    .plugEntry {
      border: 1px solid #555;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      background: #333;
      position: relative;
    }
    .plugStatus {
      font-weight: bold;
      margin-top: 5px;
    }
    .form-text {
      font-size: 0.85rem;
      color: #b0b0b0;
    }
    /* Graph styling */
    #mergedGraph {
      border: 1px solid #444;
      padding: 10px;
      background: #121212;
      border-radius: 5px;
      width: 100%;
      max-width: 100%;
      height: 400px;
    }
    /* Timer styling */
    #timerContainer {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: 15px;
      flex-wrap: wrap;
    }
    #refreshTimer {
      font-size: 1.5em;
      font-weight: bold;
      color: #00ff00;
      border: 2px solid #00ff00;
      border-radius: 5px;
      padding: 5px 10px;
      white-space: nowrap;
    }
    #timerLabel {
      font-size: 1em;
      color: #f0f0f0;
    }
    /* Advanced Settings styling */
    .plugAdvancedSettings {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #555;
      border-radius: 4px;
      background: #444;
    }
    .forcedRule {
      border: 1px solid #666;
      padding: 5px;
      margin-bottom: 5px;
      border-radius: 3px;
      background: #555;
    }
    .forcedRule input.form-control, 
    .forcedRule select.form-control {
      color: #e0e0e0;
      background-color: #444;
    }
    /* Prevent Screensaver Toggle styling */
    #screensaverToggleContainer {
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Top Controls: Save/Load Settings and Prevent Screensaver Toggle -->
    <div id="settingsButtons" class="mb-3 d-flex justify-content-between align-items-center">
      <div>
        <button type="button" class="btn btn-success" id="saveSettingsBtn">Save Settings</button>
        <button type="button" class="btn btn-warning" id="loadSettingsBtn">Load Settings</button>
      </div>
      <div id="screensaverToggleContainer" class="form-check">
        <input class="form-check-input" type="checkbox" id="preventScreensaverToggle">
        <label class="form-check-label" for="preventScreensaverToggle">Prevent Screensaver</label>
      </div>
    </div>
    
    <!-- Automatic Geolocation Display -->
    <div id="locationDisplay" class="mt-3">
      <p>Attempting to retrieve your location...</p>
    </div>
    
    <!-- Manual Location Input with Timer -->
    <h2 class="mt-5">Enter Location Manually</h2>
    <form id="locationForm">
      <div class="form-group">
        <input type="text" class="form-control" id="manualLocation" placeholder="Enter village or city name" required>
        <small class="form-text">Type the name of your village or city to fetch coordinates and weather.</small>
      </div>
      <div id="timerContainer">
        <button type="submit" class="btn btn-secondary">Convert to Coordinates & Retrieve Weather</button>
        <div id="timerLabel">Next Forecast Refresh:</div>
        <div id="refreshTimer">00:00:00</div>
      </div>
    </form>
    <div id="manualLocationResult" class="mt-3"></div>
    
    <!-- Forecast Section -->
    <div id="forecastSection" class="mt-5">
      <h3>Weather & Renewable Energy Forecast</h3>
      <!-- Slider for renewable energy weight -->
      <div class="form-group">
        <label for="energySlider">
          Importance: <span id="sunWeightLabel">50</span>% Sun / <span id="windWeightLabel">50</span>% Wind
        </label>
        <input type="range" class="form-control-range" id="energySlider" min="0" max="100" value="50">
        <small class="form-text">Adjust the slider to set the weighting between solar (UV) and wind energy. This will update both the renewable energy quality line and (if Optimized is selected) the plug schedules immediately.</small>
      </div>
      <!-- Merged Graph Container -->
      <div id="mergedGraph" class="mt-3"></div>
    </div>
    
    <!-- Smart Plug Settings Section -->
    <div id="smartPlugSettingsSection" class="mt-5">
      <h3>Smart Plug Settings</h3>
      <!-- Schedule Type at the very top -->
      <div class="form-group">
        <label>Schedule Type:</label>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="scheduleType" id="userPlanned" value="user" checked>
          <label class="form-check-label" for="userPlanned">User Planned</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="scheduleType" id="optimized" value="optimized">
          <label class="form-check-label" for="optimized">Optimized (Weather-based)</label>
        </div>
      </div>
      <!-- Plug Settings Panel -->
      <div id="plugSchedulePanel">
        <div id="plugList"></div>
        <button type="button" class="btn btn-outline-secondary mb-2" id="addPlugBtn">Add Plug</button>
        <small class="form-text mb-2">Click "Add Plug" to add a new smart plug. Fill in the details below for each plug.</small>
        <button type="button" class="btn btn-info btn-block" id="updatePlugsBtn">Update Plug Schedules</button>
      </div>
    </div>
  </div>
  
  <!-- Import jQuery (Slim version) and Bootstrap JS for collapse functionality -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script>
    /*************************************
     * 1) GLOBAL VARIABLES & TIMER SETUP *
     *************************************/
    let weatherTimeData = null;
    let weatherWindData = null;
    let weatherUvData = null;
    let globalLineTraces = [];
    let globalMergedLayout = null;
    
    // Timer: updates once per second to show time until next top-of-hour refresh
    function updateTimer() {
      const now = new Date();
      const nextHour = new Date(now);
      nextHour.setMinutes(0, 0, 0);
      nextHour.setHours(now.getHours() + 1);
      const diff = nextHour - now;
      const seconds = Math.floor(diff / 1000) % 60;
      const minutes = Math.floor(diff / (1000 * 60)) % 60;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      document.getElementById('refreshTimer').innerText =
        (hours < 10 ? "0" + hours : hours) + ":" +
        (minutes < 10 ? "0" + minutes : minutes) + ":" +
        (seconds < 10 ? "0" + seconds : seconds);
    }
    setInterval(updateTimer, 1000);
    updateTimer(); // Initial call

    /**************************************
     * 2) SAVE/LOAD SETTINGS FROM STORAGE *
     **************************************/
    function saveSettings() {
      const settings = {
        manualLocation: document.getElementById('manualLocation').value,
        energySlider: document.getElementById('energySlider').value,
        scheduleType: document.querySelector('input[name="scheduleType"]:checked').value,
        plugs: []
      };
      const plugEntries = document.querySelectorAll('.plugEntry');
      plugEntries.forEach(entry => {
        const plug = {
          name: entry.querySelector('.plugName').value,
          onHours: entry.querySelector('.plugOnHours').value,
          totalHours: entry.querySelector('.plugTotalHours').value,
          kwh: entry.querySelector('.plugKwh').value,
          webhookOn: entry.querySelector('.webhookOn').value,
          webhookOff: entry.querySelector('.webhookOff').value,
          forcedRules: []
        };
        entry.querySelectorAll('.forcedRule').forEach(rule => {
          const daysSelect = rule.querySelector('.forcedRuleDays');
          const selectedDays = Array.from(daysSelect.selectedOptions).map(opt => opt.value);
          plug.forcedRules.push({
            days: selectedDays,
            start: rule.querySelector('.forcedRuleStart').value,
            end: rule.querySelector('.forcedRuleEnd').value,
            state: rule.querySelector('.forcedRuleState').value
          });
        });
        settings.plugs.push(plug);
      });
      localStorage.setItem("dashboardSettings", JSON.stringify(settings));
      alert("Settings saved.");
    }
    
    function loadSettings() {
      const settingsStr = localStorage.getItem("dashboardSettings");
      if (!settingsStr) { alert("No settings found."); return; }
      const settings = JSON.parse(settingsStr);
      document.getElementById('manualLocation').value = settings.manualLocation;
      document.getElementById('energySlider').value = settings.energySlider;
      document.getElementById('sunWeightLabel').textContent = settings.energySlider;
      document.getElementById('windWeightLabel').textContent = 100 - settings.energySlider;
      document.querySelector(`input[name="scheduleType"][value="${settings.scheduleType}"]`).checked = true;
      const plugList = document.getElementById('plugList');
      plugList.innerHTML = "";
      settings.plugs.forEach((plug) => { addPlug(plug); });
      alert("Settings loaded.");
      document.getElementById("locationForm").dispatchEvent(new Event('submit'));
    }
    document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
    document.getElementById('loadSettingsBtn').addEventListener('click', loadSettings);
    
    /****************************************
     * 3) GEOLOCATION & WEATHER RETRIEVAL    *
     ****************************************/
    function setLocationDisplay(data, latitude, longitude) {
      const address = data.address || {};
      const place = address.city || address.town || address.village || address.hamlet || "";
      let displayText = `Your coordinates: Latitude: ${latitude.toFixed(4)}, Longitude: ${longitude.toFixed(4)}`;
      if (place) { displayText += `<br>Location: ${place}`; }
      if (address.country) { displayText += `<br>Country: ${address.country}`; }
      document.getElementById('locationDisplay').innerHTML = `<p>${displayText}</p>`;
      const manualField = document.getElementById('manualLocation');
      if (!manualField.value && place) { manualField.value = place; }
    }
    
    const locationDisplay = document.getElementById('locationDisplay');
    locationDisplay.innerHTML = '<p>Attempting to retrieve your location...</p>';
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        const reverseUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&addressdetails=1`;
        fetch(reverseUrl)
          .then(response => response.json())
          .then(data => { setLocationDisplay(data, latitude, longitude); })
          .catch(error => { locationDisplay.innerHTML = `<p>Your coordinates: Latitude: ${latitude.toFixed(4)}, Longitude: ${longitude.toFixed(4)}</p>`; });
      }, function(error) { locationDisplay.innerHTML = `<p>Error getting location: ${error.message}</p>`; });
    } else {
      locationDisplay.innerHTML = '<p>Geolocation is not supported by this browser.</p>';
    }
    setTimeout(function() {
      if (locationDisplay.innerHTML.includes("Attempting to retrieve your location")) {
        locationDisplay.innerHTML = '<p>Automatic location retrieval is taking too long. Please use the manual input below.</p>';
      }
    }, 5000);
    
    // Manual location form
    document.getElementById('locationForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const locationName = document.getElementById('manualLocation').value;
      const manualLocationResult = document.getElementById('manualLocationResult');
      manualLocationResult.innerHTML = '<p>Converting location to coordinates...</p>';
      const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=1&q=${encodeURIComponent(locationName)}`;
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data && data.length > 0) {
            const lat = data[0].lat;
            const lon = data[0
